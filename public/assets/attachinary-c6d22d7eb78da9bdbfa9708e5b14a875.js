(function(){!function(i){return i.attachinary={index:0,config:{disableWith:"Uploading...",indicateProgress:!0,invalidFormatMessage:"Invalid file format",template:'<ul>\n  <% for(var i=0; i<files.length; i++){ %>\n    <li>\n      <% if(files[i].resource_type == "raw") { %>\n        <div class="raw-file"></div>\n      <% } else { %>\n        <img\n          src="<%= $.cloudinary.url(files[i].public_id, { "version": files[i].version, "format": \'jpg\', "crop": \'fill\', "width": 75, "height": 75 }) %>"\n          alt="" width="75" height="75" />\n      <% } %>\n      <a href="#" data-remove="<%= files[i].public_id %>">Remove</a>\n    </li>\n  <% } %>\n</ul>',render:function(t){return i.attachinary.Templating.template(this.template,{files:t})}}},i.fn.attachinary=function(t){var e;return e=i.extend({},i.attachinary.config,t),this.each(function(){var t;return t=i(this),t.data("attachinary-bond")?void 0:t.data("attachinary-bond",new i.attachinary.Attachinary(t,e))})},i.attachinary.Attachinary=function(){function t(i,t){var e;this.$input=i,this.config=t,this.options=this.$input.data("attachinary"),this.files=this.options.files,this.$form=this.$input.closest("form"),this.$submit=this.$form.find(null!=(e=this.options.submit_selector)?e:"input[type=submit]"),null!=this.options.wrapper_container_selector&&(this.$wrapper=this.$input.closest(this.options.wrapper_container_selector)),this.initFileUpload(),this.addFilesContainer(),this.bindEventHandlers(),this.redraw(),this.checkMaximum()}return t.prototype.initFileUpload=function(){var i;return this.options.field_name=this.$input.attr("name"),i={dataType:"json",paramName:"file",headers:{"X-Requested-With":"XMLHttpRequest"},dropZone:this.config.dropZone||this.$input,sequentialUploads:!0},this.$input.attr("accept")&&(i.acceptFileTypes=new RegExp("^"+this.$input.attr("accept").split(",").join("|")+"$","i")),this.$input.fileupload(i)},t.prototype.bindEventHandlers=function(){return this.$input.bind("fileuploadsend",function(t){return function(){return t.$input.addClass("uploading"),null!=t.$wrapper&&t.$wrapper.addClass("uploading"),t.$form.addClass("uploading"),t.$input.prop("disabled",!0),t.config.disableWith&&(t.$submit.each(function(t,e){var n;return n=i(e),null==n.data("old-val")?n.data("old-val",n.val()):void 0}),t.$submit.val(t.config.disableWith),t.$submit.prop("disabled",!0)),!t.maximumReached()}}(this)),this.$input.bind("fileuploaddone",function(i){return function(t,e){return i.addFile(e.result)}}(this)),this.$input.bind("fileuploadstart",function(t){return function(e){return t.$input=i(e.target)}}(this)),this.$input.bind("fileuploadalways",function(t){return function(){return t.$input.removeClass("uploading"),null!=t.$wrapper&&t.$wrapper.removeClass("uploading"),t.$form.removeClass("uploading"),t.checkMaximum(),t.config.disableWith?(t.$submit.each(function(t,e){var n;return n=i(e),n.val(n.data("old-val"))}),t.$submit.prop("disabled",!1)):void 0}}(this)),this.$input.bind("fileuploadprogressall",function(i){return function(t,e){var n;return n=parseInt(e.loaded/e.total*100,10),i.config.disableWith&&i.config.indicateProgress?i.$submit.val("["+n+"%] "+i.config.disableWith):void 0}}(this))},t.prototype.addFile=function(t){return this.options.accept&&-1===i.inArray(t.format,this.options.accept)&&-1===i.inArray(t.resource_type,this.options.accept)?alert(this.config.invalidFormatMessage):(this.files.push(t),this.redraw(),this.checkMaximum(),this.$input.trigger("attachinary:fileadded",[t]))},t.prototype.removeFile=function(i){var t,e,n,a,r,s;for(t=[],s=null,r=this.files,n=0,a=r.length;a>n;n++)e=r[n],e.public_id===i?s=e:t.push(e);return this.files=t,this.redraw(),this.checkMaximum(),this.$input.trigger("attachinary:fileremoved",[s])},t.prototype.checkMaximum=function(){return this.maximumReached()?(null!=this.$wrapper&&this.$wrapper.addClass("disabled"),this.$input.prop("disabled",!0)):(null!=this.$wrapper&&this.$wrapper.removeClass("disabled"),this.$input.prop("disabled",!1))},t.prototype.maximumReached=function(){return this.options.maximum&&this.files.length>=this.options.maximum},t.prototype.addFilesContainer=function(){return null!=this.options.files_container_selector&&i(this.options.files_container_selector).length>0?this.$filesContainer=i(this.options.files_container_selector):(this.$filesContainer=i('<div class="attachinary_container">'),this.$input.after(this.$filesContainer))},t.prototype.redraw=function(){return this.$filesContainer.empty(),this.files.length>0?(this.$filesContainer.append(this.makeHiddenField(JSON.stringify(this.files))),this.$filesContainer.append(this.config.render(this.files)),this.$filesContainer.find("[data-remove]").on("click",function(t){return function(e){return e.preventDefault(),t.removeFile(i(e.target).data("remove"))}}(this)),this.$filesContainer.show()):(this.$filesContainer.append(this.makeHiddenField(null)),this.$filesContainer.hide())},t.prototype.makeHiddenField=function(t){var e;return e=i('<input type="hidden">'),e.attr("name",this.options.field_name),e.val(t),e},t}(),i.attachinary.Templating={settings:{start:"<%",end:"%>",interpolate:/<%=(.+?)%>/g},escapeRegExp:function(i){return i.replace(/([.*+?^${}()|[\]\/\\])/g,"\\$1")},template:function(i,t){var e,n,a;return e=this.settings,n=new RegExp("'(?=[^"+e.end.substr(0,1)+"]*"+this.escapeRegExp(e.end)+")","g"),a=new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj||{}){p.push('"+i.replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t").replace(n,"\u2704").split("'").join("\\'").split("\u2704").join("'").replace(e.interpolate,"',$1,'").split(e.start).join("');").split(e.end).join("p.push('")+"');}return p.join('');"),t?a(t):a}}}(jQuery)}).call(this);